#include "percent_encod_decod.h"
#include<string.h>
#include<stdio.h>

/**
 * @brief Lookup table for percent encoding.
 */
const unsigned char EncLT[BYTE][PERC_ENC_SIZE+1]={
	    {'%', '0', '0' , '\0'}, {'%', '0', '1' , '\0'}, {'%', '0', '2' , '\0'}, {'%', '0', '3' , '\0'}, {'%', '0', '4' , '\0'}, {'%', '0', '5' , '\0'}, {'%', '0', '6' , '\0'}, {'%', '0', '7' , '\0'}, {'%', '0', '8' , '\0'},
        {'%', '0', '9' , '\0'}, {'%', '0', 'A' , '\0'}, {'%', '0', 'B' , '\0'}, {'%', '0', 'C' , '\0'}, {'%', '0', 'D' , '\0'}, {'%', '0', 'E' , '\0'}, {'%', '0', 'F' , '\0'}, 
        {'%', '1', '0' , '\0'}, {'%', '1', '1' , '\0'}, {'%', '1', '2' , '\0'}, {'%', '1', '3' , '\0'}, {'%', '1', '4' , '\0'}, {'%', '1', '5' , '\0'}, {'%', '1', '6' , '\0'}, {'%', '1', '7' , '\0'}, {'%', '1', '8' , '\0'},
        {'%', '1', '9' , '\0'}, {'%', '1', 'A' , '\0'}, {'%', '1', 'B' , '\0'}, {'%', '1', 'C' , '\0'}, {'%', '1', 'D' , '\0'}, {'%', '1', 'E' , '\0'}, {'%', '1', 'F' , '\0'},
        {'%', '2', '0' , '\0'}, {'%', '2', '1' , '\0'}, {'%', '2', '2' , '\0'}, {'%', '2', '3' , '\0'}, {'%', '2', '4' , '\0'}, {'%', '2', '5' , '\0'}, {'%', '2', '6' , '\0'}, {'%', '2', '7' , '\0'}, {'%', '2', '8' , '\0'},
        {'%', '2', '9' , '\0'}, {'%', '2', 'A' , '\0'}, {'%', '2', 'B' , '\0'}, {'%', '2', 'C' , '\0'}, {'%', '2', 'D' , '\0'}, {'%', '2', 'E' , '\0'}, {'%', '2', 'F' , '\0'},
        {'%', '3', '0' , '\0'}, {'%', '3', '1' , '\0'}, {'%', '3', '2' , '\0'}, {'%', '3', '3' , '\0'}, {'%', '3', '4' , '\0'}, {'%', '3', '5' , '\0'}, {'%', '3', '6' , '\0'}, {'%', '3', '7' , '\0'}, {'%', '3', '8' , '\0'},
        {'%', '3', '9' , '\0'}, {'%', '3', 'A' , '\0'}, {'%', '3', 'B' , '\0'}, {'%', '3', 'C' , '\0'}, {'%', '3', 'D' , '\0'}, {'%', '3', 'E' , '\0'}, {'%', '3', 'F' , '\0'},
        {'%', '4', '0' , '\0'}, {'%', '4', '1' , '\0'}, {'%', '4', '2' , '\0'}, {'%', '4', '3' , '\0'}, {'%', '4', '4' , '\0'}, {'%', '4', '5' , '\0'}, {'%', '4', '6' , '\0'}, {'%', '4', '7' , '\0'}, {'%', '4', '8' , '\0'},
        {'%', '4', '9' , '\0'}, {'%', '4', 'A' , '\0'}, {'%', '4', 'B' , '\0'}, {'%', '4', 'C' , '\0'}, {'%', '4', 'D' , '\0'}, {'%', '4', 'E' , '\0'}, {'%', '4', 'F' , '\0'},
        {'%', '5', '0' , '\0'}, {'%', '5', '1' , '\0'}, {'%', '5', '2' , '\0'}, {'%', '5', '3' , '\0'}, {'%', '5', '4' , '\0'}, {'%', '5', '5' , '\0'}, {'%', '5', '6' , '\0'}, {'%', '5', '7' , '\0'}, {'%', '5', '8' , '\0'},
        {'%', '5', '9' , '\0'}, {'%', '5', 'A' , '\0'}, {'%', '5', 'B' , '\0'}, {'%', '5', 'C' , '\0'}, {'%', '5', 'D' , '\0'}, {'%', '5', 'E' , '\0'}, {'%', '5', 'F' , '\0'},
        {'%', '6', '0' , '\0'}, {'%', '6', '1' , '\0'}, {'%', '6', '2' , '\0'}, {'%', '6', '3' , '\0'}, {'%', '6', '4' , '\0'}, {'%', '6', '5' , '\0'}, {'%', '6', '6' , '\0'}, {'%', '6', '7' , '\0'}, {'%', '6', '8' , '\0'},
        {'%', '6', '9' , '\0'}, {'%', '6', 'A' , '\0'}, {'%', '6', 'B' , '\0'}, {'%', '6', 'C' , '\0'}, {'%', '6', 'D' , '\0'}, {'%', '6', 'E' , '\0'}, {'%', '6', 'F' , '\0'},
        {'%', '7', '0' , '\0'}, {'%', '7', '1' , '\0'}, {'%', '7', '2' , '\0'}, {'%', '7', '3' , '\0'}, {'%', '7', '4' , '\0'}, {'%', '7', '5' , '\0'}, {'%', '7', '6' , '\0'}, {'%', '7', '7' , '\0'}, {'%', '7', '8' , '\0'},
        {'%', '7', '9' , '\0'}, {'%', '7', 'A' , '\0'}, {'%', '7', 'B' , '\0'}, {'%', '7', 'C' , '\0'}, {'%', '7', 'D' , '\0'}, {'%', '7', 'E' , '\0'}, {'%', '7', 'F' , '\0'},
        {'%', '8', '0' , '\0'}, {'%', '8', '1' , '\0'}, {'%', '8', '2' , '\0'}, {'%', '8', '3' , '\0'}, {'%', '8', '4' , '\0'}, {'%', '8', '5' , '\0'}, {'%', '8', '6' , '\0'}, {'%', '8', '7' , '\0'}, {'%', '8', '8' , '\0'},
        {'%', '8', '9' , '\0'}, {'%', '8', 'A' , '\0'}, {'%', '8', 'B' , '\0'}, {'%', '8', 'C' , '\0'}, {'%', '8', 'D' , '\0'}, {'%', '8', 'E' , '\0'}, {'%', '8', 'F' , '\0'},
        {'%', '9', '0' , '\0'}, {'%', '9', '1' , '\0'}, {'%', '9', '2' , '\0'}, {'%', '9', '3' , '\0'}, {'%', '9', '4' , '\0'}, {'%', '9', '5' , '\0'}, {'%', '9', '6' , '\0'}, {'%', '9', '7' , '\0'}, {'%', '9', '8' , '\0'},
        {'%', '9', '9' , '\0'}, {'%', '9', 'A' , '\0'}, {'%', '9', 'B' , '\0'}, {'%', '9', 'C' , '\0'}, {'%', '9', 'D' , '\0'}, {'%', '9', 'E' , '\0'}, {'%', '9', 'F' , '\0'},
        {'%', 'A', '0' , '\0'}, {'%', 'A', '1' , '\0'}, {'%', 'A', '2' , '\0'}, {'%', 'A', '3' , '\0'}, {'%', 'A', '4' , '\0'}, {'%', 'A', '5' , '\0'}, {'%', 'A', '6' , '\0'}, {'%', 'A', '7' , '\0'}, {'%', 'A', '8' , '\0'},
        {'%', 'A', '9' , '\0'}, {'%', 'A', 'A' , '\0'}, {'%', 'A', 'B' , '\0'}, {'%', 'A', 'C' , '\0'}, {'%', 'A', 'D' , '\0'}, {'%', 'A', 'E' , '\0'}, {'%', 'A', 'F' , '\0'},
        {'%', 'B', '0' , '\0'}, {'%', 'B', '1' , '\0'}, {'%', 'B', '2' , '\0'}, {'%', 'B', '3' , '\0'}, {'%', 'B', '4' , '\0'}, {'%', 'B', '5' , '\0'}, {'%', 'B', '6' , '\0'}, {'%', 'B', '7' , '\0'}, {'%', 'B', '8' , '\0'},
        {'%', 'B', '9' , '\0'}, {'%', 'B', 'A' , '\0'}, {'%', 'B', 'B' , '\0'}, {'%', 'B', 'C' , '\0'}, {'%', 'B', 'D' , '\0'}, {'%', 'B', 'E' , '\0'}, {'%', 'B', 'F' , '\0'},
        {'%', 'C', '0' , '\0'}, {'%', 'C', '1' , '\0'}, {'%', 'C', '2' , '\0'}, {'%', 'C', '3' , '\0'}, {'%', 'C', '4' , '\0'}, {'%', 'C', '5' , '\0'}, {'%', 'C', '6' , '\0'}, {'%', 'C', '7' , '\0'}, {'%', 'C', '8' , '\0'},
        {'%', 'C', '9' , '\0'}, {'%', 'C', 'A' , '\0'}, {'%', 'C', 'B' , '\0'}, {'%', 'C', 'C' , '\0'}, {'%', 'C', 'D' , '\0'}, {'%', 'C', 'E' , '\0'}, {'%', 'C', 'F' , '\0'},
        {'%', 'D', '0' , '\0'}, {'%', 'D', '1' , '\0'}, {'%', 'D', '2' , '\0'}, {'%', 'D', '3' , '\0'}, {'%', 'D', '4' , '\0'}, {'%', 'D', '5' , '\0'}, {'%', 'D', '6' , '\0'}, {'%', 'D', '7' , '\0'}, {'%', 'D', '8' , '\0'},
        {'%', 'D', '9' , '\0'}, {'%', 'D', 'A' , '\0'}, {'%', 'D', 'B' , '\0'}, {'%', 'D', 'C' , '\0'}, {'%', 'D', 'D' , '\0'}, {'%', 'D', 'E' , '\0'}, {'%', 'D', 'F' , '\0'},
        {'%', 'E', '0' , '\0'}, {'%', 'E', '1' , '\0'}, {'%', 'E', '2' , '\0'}, {'%', 'E', '3' , '\0'}, {'%', 'E', '4' , '\0'}, {'%', 'E', '5' , '\0'}, {'%', 'E', '6' , '\0'}, {'%', 'E', '7' , '\0'}, {'%', 'E', '8' , '\0'},
        {'%', 'E', '9' , '\0'}, {'%', 'E', 'A' , '\0'}, {'%', 'E', 'B' , '\0'}, {'%', 'E', 'C' , '\0'}, {'%', 'E', 'D' , '\0'}, {'%', 'E', 'E' , '\0'}, {'%', 'E', 'F' , '\0'},
        {'%', 'F', '0' , '\0'}, {'%', 'F', '1' , '\0'}, {'%', 'F', '2' , '\0'}, {'%', 'F', '3' , '\0'}, {'%', 'F', '4' , '\0'}, {'%', 'F', '5' , '\0'}, {'%', 'F', '6' , '\0'}, {'%', 'F', '7' , '\0'}, {'%', 'F', '8' , '\0'},
        {'%', 'F', '9' , '\0'}, {'%', 'F', 'A' , '\0'}, {'%', 'F', 'B' , '\0'}, {'%', 'F', 'C' , '\0'}, {'%', 'F', 'D' , '\0'}, {'%', 'F', 'E' , '\0'}, {'%', 'F', 'F' , '\0'}
};



/**
 * @brief Performs percent encoding for URIs.
 * @param param1 passes pointer to the plain text.
 * @param param2 passes the size of the input plain text.
 * @param param3 passes the pointer to the array where encoded text will be stored. (ostream array must be at minimum, 3 times the size of istream)
 * @return returns the length of the encoded text.
 */
unsigned int percent_encode(unsigned char* istream, unsigned int size_istream, unsigned char* ostream){
	unsigned int size_ostream=0;
	for(int i=0;i<size_istream;i++){
		if( ((*istream>=48)&&(*istream<=57))  || 
		    ((*istream>=65)&&(*istream<=90))  || 
		    ((*istream>=97)&&(*istream<=122)) || 
		    (*istream=='-') 		      || 
		    (*istream=='.') 	              || 
		    (*istream=='_') 		      || 
		    (*istream=='~') 		      ){  // i.e. char is in unreserved char set, thus no encoding.
						 		*ostream=*istream;
							 	ostream++;
								size_ostream++;	
		}else{	// i.e. char is in reserved or non-ascii or utf-n set, thus encoding.
			memcpy(ostream,EncLT[*istream],3);
			ostream+=3;
			size_ostream+=3;
		}	
		istream++;
	}
	return size_ostream;
}

/**
 * @brief Performs percent decoding for URIs.
 * @param param1 passes the pointer to the encoded text.
 * @param param2 passes the size of the encoded text.
 * @param param3 passes the pointer to the array where decoded text will be stored. (ostream array must be at minimum of same size of istream)
 * @return returns the length of the decoded text.
 */
unsigned int percent_decode(unsigned char* istream, unsigned int size_istream, unsigned char* ostream){
	unsigned char* ostart=ostream;
	unsigned char* iend=istream+size_istream; // pointing 1 byte out of istream
    int it=0;
	while(istream<iend){
        printf("iter : %d\n",it);
        it++;
		if(*istream=='%'){ // encoded char present, needed to be decoded.
                  printf("In if block\n");
                  printf("curr istream char : %d %c %#x\n",*istream,*istream,*istream);
				  *ostream=( (*(istream+1)-( (*(istream+1))>'9' ? ASCII_REDUC_VAL1 : ASCII_REDUC_VAL0 ))<<4 | (*(istream+2)-((*(istream+2))>'9' ? ASCII_REDUC_VAL1 : ASCII_REDUC_VAL0 )) ); // subtracting ASCII_REDUC_VAL to map chars to their actual integral values since encoding converts value into hex digit chars.
                  printf("ostream  : %d %c %#x\n",*ostream,*ostream,*ostream);
   				  istream+=3;
                  printf("istream now pointing to  : %d %c %#x\n",*istream,*istream,*istream);
		
		}else{
              printf("In else block\n");
              printf("curr istream char : %d %c %#x\n",*istream,*istream,*istream);
		      *ostream=*istream;
              printf("ostream  : %d %c %#x\n",*ostream,*ostream,*ostream);
		      istream++;
              printf("istream now pointing to  : %d %c %#x\n",*istream,*istream,*istream);
		}
		ostream++; // in last ite, it will move one more byte before breaking out of loop, thus no need to add 1 in return value 
	}
	return (unsigned int)(ostream-ostart);
}


